<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tilt Maze â€“ Stable Control</title>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; background:#f6f7f9; }
    h2 { margin: 0 0 10px 0; }
    button { font-size: 18px; padding: 10px 16px; margin: 6px 0; width: 100%; }
    .box { margin-top: 12px; padding: 12px; background:#fff; border-radius: 10px;
           box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .small { color:#555; font-size: 14px; }
  </style>
</head>

<body>
  <h2>ğŸ“¦ Tilt Mazeï¼ˆç©©å®šå¯äº¤ç‰ˆï¼‰</h2>

  <button id="btnEnable">Enable Motion</button>
  <button id="btnPause">Pause Sensing</button>
  <button id="btnNeutral">Set Neutralï¼ˆç¾åœ¨å§¿å‹¢ = å¹³ï¼‰</button>
  <button id="btnCenter">Center Platform</button>

  <div class="box">
    <div>betaï¼ˆå‰å¾Œï¼‰: <span id="beta">0</span></div>
    <div>gammaï¼ˆå·¦å³ï¼‰: <span id="gamma">0</span></div>
    <div>è¼¸å‡º X / Y: <span id="xy">0 , 0</span></div>
    <div class="small">Status: <span id="status">idle</span></div>
  </div>

<script>
/* ===============================
   æ ¸å¿ƒåƒæ•¸ï¼ˆå·²ç‚ºä½ èª¿å¥½ï¼‰
   =============================== */

// å‚³é€é »ç‡ï¼ˆæ…¢ä¸€é»æ›´ç©©ï¼‰
const SEND_INTERVAL = 180;

// å°è§’åº¦å®Œå…¨ä¸å‹•
const DEADZONE = 0.22;

// æœ‰æ•ˆè§’åº¦ç¯„åœ
const MAX_DEG = 18;

// å¹³æ»‘
const EMA_ALPHA = 0.10;

// é‡åŒ–ï¼Œé¿å…æŠ–
const STEP = 0.12;

// å¤ªå°è®ŠåŒ–ä¸é€
const SEND_EPS = 0.06;

// è»¸å¢ç›Šï¼ˆY å¤§æ–¼ Xï¼‰
const TILT_GAIN_X = 0.45;
const TILT_GAIN_Y = 0.80;

// â­ é—œéµï¼šå…è¨± X æ¨å¾—å¤ å¤§
const MAX_OUT_X = 0.42;
const MAX_OUT_Y = 0.60;

// æ–¹å‘ï¼ˆä¸å°å°±æ”¹æˆ 1ï¼‰
const INVERT_X = -1;
const INVERT_Y = -1;

// Y è»¸èµ·å‹•é–€æª»ï¼ˆY å¾ˆæ˜é¡¯æ™‚æ‰æŠ‘åˆ¶ Xï¼‰
const ACTIVATE_Y = 0.20;

/* ===============================
   ç‹€æ…‹
   =============================== */
let enabled = false;
let sensing = true;
let lastSend = 0;

let emaX = 0, emaY = 0;
let lastOutX = 0, lastOutY = 0;

let neutralSet = false;
let neutralBeta = 0, neutralGamma = 0;
let neutralAlpha = 0, lastAlpha = 0;

/* ===============================
   DOM
   =============================== */
const betaEl = document.getElementById('beta');
const gammaEl = document.getElementById('gamma');
const xyEl = document.getElementById('xy');
const statusEl = document.getElementById('status');
const btnPause = document.getElementById('btnPause');

/* ===============================
   å·¥å…·
   =============================== */
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
function normalize(deg) { return clamp(deg / MAX_DEG, -1, 1); }
function deadzone(v, dz) { return Math.abs(v) < dz ? 0 : v; }
function quantize(v, step) { return Math.round(v / step) * step; }

/* ===============================
   API
   =============================== */
async function sendXY(x, y) {
  try {
    const r = await fetch('/api/tilt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ x, y })
    });
    const d = await r.json();
    statusEl.textContent = `X_PWM=${d.x_pwm} Y_PWM=${d.y_pwm}` + (sensing ? '' : ' (paused)');
  } catch {
    statusEl.textContent = 'send error';
  }
}

/* ===============================
   Buttons
   =============================== */
document.getElementById('btnEnable').onclick = async () => {
  if (typeof DeviceMotionEvent !== 'undefined' &&
      typeof DeviceMotionEvent.requestPermission === 'function') {
    const p = await DeviceMotionEvent.requestPermission();
    enabled = (p === 'granted');
  } else {
    enabled = true;
  }
  statusEl.textContent = enabled ? 'motion enabled' : 'motion denied';
};

btnPause.onclick = async () => {
  sensing = !sensing;
  btnPause.textContent = sensing ? 'Pause Sensing' : 'Resume Sensing';
  if (!sensing) await sendXY(0, 0);
};

document.getElementById('btnNeutral').onclick = () => {
  neutralSet = true;
  neutralAlpha = lastAlpha;
  statusEl.textContent = 'neutral set âœ”';
};

document.getElementById('btnCenter').onclick = async () => {
  await fetch('/api/center', { method: 'POST' });
};

/* ===============================
   Device Orientation
   =============================== */
window.addEventListener('deviceorientation', (e) => {
  if (!enabled || !sensing) return;

  const beta = e.beta || 0;
  const gamma = e.gamma || 0;
  const alpha = e.alpha || 0;
  lastAlpha = alpha;

  betaEl.textContent = beta.toFixed(1);
  gammaEl.textContent = gamma.toFixed(1);

  if (!neutralSet) {
    neutralBeta = beta;
    neutralGamma = gamma;
    neutralAlpha = alpha;
    xyEl.textContent = "0 , 0ï¼ˆè«‹å…ˆ Set Neutralï¼‰";
    return;
  }

  // ç›¸å°å‚¾æ–œ
  const rb = beta - neutralBeta;
  const rg = gamma - neutralGamma;

  // yaw è£œå„Ÿ
  const yaw = (alpha - neutralAlpha) * Math.PI / 180;
  let x = rg * Math.cos(yaw) - rb * Math.sin(yaw);
  let y = rg * Math.sin(yaw) + rb * Math.cos(yaw);

  // normalize + gain
  x = normalize(x) * TILT_GAIN_X;
  y = normalize(y) * TILT_GAIN_Y;

  // deadzone
  x = deadzone(x, DEADZONE);
  y = deadzone(y, DEADZONE);

  // EMA
  emaX = EMA_ALPHA * x + (1 - EMA_ALPHA) * emaX;
  emaY = EMA_ALPHA * y + (1 - EMA_ALPHA) * emaY;

  // quantize
  let outX = quantize(emaX, STEP) * INVERT_X;
  let outY = quantize(emaY, STEP) * INVERT_Y;

  // clampï¼ˆå®‰å…¨ï¼‰
  outX = clamp(outX, -MAX_OUT_X, MAX_OUT_X);
  outY = clamp(outY, -MAX_OUT_Y, MAX_OUT_Y);

  // â­ æ ¸å¿ƒé‚è¼¯ï¼š
  // Y å¾ˆæ˜é¡¯æ™‚ï¼Œæ‰æš«æ™‚æŠ‘åˆ¶ Xï¼Œé¿å…å‰å¾Œæ“ä½œæ™‚å·¦å³äº‚å‹•
  if (Math.abs(outY) >= ACTIVATE_Y) {
    outX = 0;
  }

  xyEl.textContent = `${outX.toFixed(2)} , ${outY.toFixed(2)}`;

  const dx = Math.abs(outX - lastOutX);
  const dy = Math.abs(outY - lastOutY);
  if (dx < SEND_EPS && dy < SEND_EPS) return;

  const now = Date.now();
  if (now - lastSend > SEND_INTERVAL) {
    lastSend = now;
    lastOutX = outX;
    lastOutY = outY;
    sendXY(outX, outY);
  }
}, true);
</script>
</body>
</html>

