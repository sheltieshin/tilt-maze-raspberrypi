<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tilt Maze â€“ Gamepad Control</title>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background:#111;
      color:#fff;
      margin:0;
      padding:0;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }

    .container {
      width:360px;
      text-align:center;
    }

    h2 {
      margin:10px 0 14px;
      font-weight:600;
    }

    .pad {
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:10px;
      justify-items:center;
      align-items:center;
      margin:20px 0;
    }

    .pad button {
      width:90px;
      height:90px;
      border-radius:18px;
      border:none;
      font-size:32px;
      background:#263238;
      color:white;
    }

    .pad button:active {
      background:#42a5f5;
    }

    .pad .empty {
      visibility:hidden;
    }

    .bar {
      display:flex;
      justify-content:space-between;
      margin-top:10px;
    }

    .bar button {
      flex:1;
      margin:0 4px;
      padding:10px;
      font-size:14px;
      border-radius:10px;
      border:none;
      background:#455a64;
      color:white;
    }

    .info {
      margin-top:10px;
      font-size:14px;
      color:#ccc;
    }
  </style>
</head>

<body>
<div class="container">
  <h2>ðŸŽ® Tilt Maze</h2>

  <!-- D-Pad -->
  <div class="pad">
    <div class="empty"></div>
    <button id="up">â–²</button>
    <div class="empty"></div>

    <button id="left">â—€</button>
    <div class="empty"></div>
    <button id="right">â–¶</button>

    <div class="empty"></div>
    <button id="down">â–¼</button>
    <div class="empty"></div>
  </div>

  <div class="bar">
    <button id="enable">Enable</button>
    <button id="pause">Pause</button>
    <button id="center">Center</button>
  </div>

  <div class="info">
    X/Yï¼š<span id="xy">0 , 0</span><br/>
    <span id="status">idle</span>
  </div>
</div>

<script>
/* ===============================
   æ‰‹æ„Ÿåƒæ•¸ï¼ˆå·²ç‚ºä½ èª¿å¥½ï¼‰
   =============================== */

// åˆå§‹å°å‚¾æ–œï¼ˆçŸ­æŒ‰ï¼‰
const BASE_X = 0.30;
const BASE_Y = 0.45;

// æœ€å¤§å‚¾æ–œï¼ˆé•·æŒ‰ä¸Šé™ï¼‰
const MAX_X  = 0.65;
const MAX_Y  = 0.85;

// æ¯æ¬¡åŠ é€Ÿé‡
const ACC_X = 0.04;
const ACC_Y = 0.06;

// åŠ é€Ÿé–“éš”
const INTERVAL = 160;

let enabled = false;
let paused = false;
let holdTimer = null;

let curX = 0;
let curY = 0;

const xyEl = document.getElementById('xy');
const statusEl = document.getElementById('status');

function clamp(v, min, max) {
  return Math.max(min, Math.min(max, v));
}

async function sendXY(x, y) {
  try {
    const r = await fetch('/api/tilt', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({x,y})
    });
    const d = await r.json();
    statusEl.textContent = `X_PWM=${d.x_pwm} Y_PWM=${d.y_pwm}`;
  } catch {
    statusEl.textContent = 'send error';
  }
}

function update(x, y) {
  if (!enabled || paused) return;
  curX = x;
  curY = y;
  xyEl.textContent = `${x.toFixed(2)} , ${y.toFixed(2)}`;
  sendXY(x, y);
}

function stop() {
  clearInterval(holdTimer);
  holdTimer = null;
  update(0, 0);
}

/* ===============================
   é•·æŒ‰åŠ é€ŸæŽ§åˆ¶
   =============================== */
function startHold(dir) {
  if (!enabled || paused) return;

  clearInterval(holdTimer);

  // åˆå§‹å°å‚¾æ–œ
  if (dir === 'up')    update(0,  BASE_Y);
  if (dir === 'down')  update(0, -BASE_Y);
  if (dir === 'left')  update(-BASE_X, 0);
  if (dir === 'right') update( BASE_X, 0);

  holdTimer = setInterval(() => {
    if (dir === 'up')    curY = clamp(curY + ACC_Y, 0,  MAX_Y);
    if (dir === 'down')  curY = clamp(curY - ACC_Y, -MAX_Y, 0);
    if (dir === 'left')  curX = clamp(curX - ACC_X, -MAX_X, 0);
    if (dir === 'right') curX = clamp(curX + ACC_X, 0,  MAX_X);
    update(curX, curY);
  }, INTERVAL);
}

/* ===============================
   ç¶å®šæŒ‰éµ
   =============================== */
function bind(btn, dir) {
  btn.addEventListener('mousedown', () => startHold(dir));
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);

  btn.addEventListener('touchstart', e => {
    e.preventDefault();
    startHold(dir);
  }, {passive:false});

  btn.addEventListener('touchend', stop);
  btn.addEventListener('touchcancel', stop);
}

bind(document.getElementById('up'), 'up');
bind(document.getElementById('down'), 'down');
bind(document.getElementById('left'), 'left');
bind(document.getElementById('right'), 'right');

/* ===============================
   åŠŸèƒ½éµ
   =============================== */
document.getElementById('enable').onclick = () => {
  enabled = true;
  statusEl.textContent = 'enabled';
};

document.getElementById('pause').onclick = () => {
  paused = !paused;
  statusEl.textContent = paused ? 'paused' : 'resumed';
  if (paused) stop();
};

document.getElementById('center').onclick = async () => {
  await fetch('/api/center', {method:'POST'});
  stop();
};
</script>
</body>
</html>

